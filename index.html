# å¤–éƒ¨JSç‰ˆï¼ˆNetlifyå‘ã‘ï¼‰

ä»¥ä¸‹ã®2ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åŒã˜ãƒ•ã‚©ãƒ«ãƒ€ã«é…ç½®ã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ãã ã•ã„ã€‚

---

## 1) `index.html`

```html
<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WEBä¼šè­°ã‚¢ãƒ©ãƒ¼ãƒ ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ç‰ˆï¼‰</title>
  <style>
    :root{--bg:#0b1020;--card:#111a2b;--fg:#e7ecf3;--muted:#93a0b4;--line:#1e2a48;--btn:#1b2c55}
    *{box-sizing:border-box;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial}
    body{margin:0;background:#0b1020;color:var(--fg);padding:20px}
    h1{margin:0 0 8px;font-size:20px}
    .muted{color:var(--muted);font-size:12px}
    .wrap{max-width:860px;margin:auto}
    .grid{display:grid;gap:16px}
    @media(min-width:860px){.grid{grid-template-columns:1.1fr 1fr}}
    .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:16px}
    label{display:inline-block;min-width:56px}
    input,button{background:#0f1830;border:1px solid #26365f;color:var(--fg);border-radius:8px;padding:8px}
    input{width:100%;max-width:260px}
    button{cursor:pointer;background:var(--btn)}
    button:hover{filter:brightness(1.06)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:6px 0}
    .event{padding:10px;border:1px solid #2b4275;border-radius:10px;margin:8px 0}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>WEBä¼šè­°ã‚¢ãƒ©ãƒ¼ãƒ ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ç‰ˆï¼‰</h1>
    <div id="env" class="muted" style="margin:4px 0 16px"></div>

    <div class="grid">
      <!-- å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
      <section class="card">
        <h2 style="margin:0 0 10px;font-size:16px">å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ </h2>
        <div class="row">
          <label for="date">æ—¥ä»˜</label>
          <input id="date" type="date" />
        </div>
        <div class="row">
          <label for="time">æ™‚é–“</label>
          <input id="time" type="time" step="60" />
        </div>
        <div class="row">
          <label for="title">ã‚¿ã‚¤ãƒˆãƒ«</label>
          <input id="title" type="text" placeholder="ä¼šè­°åï¼ˆæœªå…¥åŠ›ãªã‚‰ã€ä¼šè­°ã€ï¼‰" />
        </div>
        <div class="row" style="margin-top:10px">
          <button id="add">è¿½åŠ </button>
          <button id="perm">é€šçŸ¥è¨±å¯</button>
          <button id="test">ãƒ†ã‚¹ãƒˆ</button>
        </div>
        <div class="muted" style="margin-top:10px">
          â€» é–‹å§‹1åˆ†å‰ï¼é–‹å§‹æ™‚åˆ»ã«ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—é€šçŸ¥ï¼‹ãƒ“ãƒ¼ãƒ—éŸ³ãŒé³´ã‚Šã¾ã™ã€‚<br>
          â€» ã‚¿ãƒ–ã‚’é–‰ã˜ã‚‹ã¨å‹•ä½œã—ã¾ã›ã‚“ã€‚<br>
          â€» é€šçŸ¥ã¯ HTTPS ã¾ãŸã¯ <code>http://localhost</code> ã§ã®å®Ÿè¡ŒãŒå®‰å®šã—ã¾ã™ã€‚
        </div>
      </section>

      <!-- ç™»éŒ²æ¸ˆã¿ -->
      <section class="card">
        <h2 style="margin:0 0 10px;font-size:16px">ç™»éŒ²æ¸ˆã¿ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</h2>
        <div id="events"></div>
      </section>
    </div>
  </div>

  <!-- å¤–éƒ¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ç¦æ­¢ã®CSPã«å¯¾å¿œï¼‰ -->
  <script src="./app.js" defer></script>
</body>
</html>
```

---

## 2) `app.js`

```js
// ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
const $ = sel => document.querySelector(sel);

function todayStr(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const dd = String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${dd}`;
}

async function beep(){
  try{
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.type = 'sine';
    osc.frequency.value = 880;
    gain.gain.value = 0.08;
    osc.connect(gain); gain.connect(ctx.destination);
    osc.start(); osc.stop(ctx.currentTime + 0.2);
    setTimeout(()=>ctx.close(), 500);
  }catch(e){ console.warn('beep error:', e); }
}

async function ensurePermission(){
  if(!('Notification' in window)) return false;
  if(Notification.permission === 'granted') return true;
  if(Notification.permission !== 'denied'){
    const r = await Notification.requestPermission();
    return r === 'granted';
  }
  return false;
}

function notify(title, body){
  try{
    if('Notification' in window && Notification.permission === 'granted'){
      new Notification(title, { body });
    }
  }catch(e){ console.warn('notify error:', e); }
}

function refreshEnv(){
  const host = location.host || '(file)';
  const secure = window.isSecureContext;
  const perm = ('Notification' in window) ? Notification.permission : 'unsupported';
  const envEl = $('#env');
  if(envEl){
    envEl.textContent = `Origin: ${host} / SecureContext: ${secure} / Notification: ${perm}`;
    if(!secure && host === ''){
      const tip = document.createElement('div');
      tip.className = 'muted';
      tip.style.marginTop = '6px';
      tip.innerHTML = 'âš ï¸ file:// å®Ÿè¡Œã§ã¯é€šçŸ¥ãŒä¸å®‰å®šã§ã™ã€‚<b>localhost</b> ã§é–‹ã„ã¦ãã ã•ã„ï¼ˆä¾‹ï¼š<code>python -m http.server 8000</code> â†’ <code>http://localhost:8000/</code>ï¼‰ã€‚';
      envEl.appendChild(tip);
    }
  }
}

// ä¿å­˜æ©Ÿèƒ½ãªã—ï¼ãƒªãƒ­ãƒ¼ãƒ‰ã§æ¶ˆãˆã‚‹
const events = [];

function render(){
  const wrap = $('#events');
  if(!wrap) return;
  wrap.innerHTML = '';
  events.sort((a,b)=>a.time - b.time);
  for(const e of events){
    const div = document.createElement('div');
    div.className = 'event';
    const t = new Date(e.time).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    div.textContent = `${t} ${e.title}`;
    wrap.appendChild(div);
  }
}

function scheduleChecks(){
  setInterval(()=>{
    const now = Date.now();
    for(const e of events){
      if(!e.firedPre && now >= e.time - 60_000 && now < e.time - 59_000){
        notify('ä¼šè­°1åˆ†å‰', e.title);
        beep();
        e.firedPre = true;
      }
      if(!e.fired && now >= e.time && now < e.time + 10_000){
        notify('ä¼šè­°é–‹å§‹', e.title);
        beep();
        e.fired = true;
      }
    }
  }, 5000);
}

window.addEventListener('load', ()=>{
  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ—¥ä»˜
  const dateEl = $('#date');
  if(dateEl) dateEl.value = todayStr();
  refreshEnv();

  // è¿½åŠ 
  $('#add')?.addEventListener('click', ()=>{
    const d = $('#date')?.value;
    const t = $('#time')?.value;
    const title = ($('#title')?.value || 'ä¼šè­°').trim();
    if(!d || !t){ alert('æ—¥ä»˜ã¨æ™‚é–“ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
    const dt = new Date(`${d}T${t}`);
    events.push({ time: dt.getTime(), title, firedPre:false, fired:false });
    render();
  });

  // é€šçŸ¥è¨±å¯
  $('#perm')?.addEventListener('click', async ()=>{
    const ok = await ensurePermission();
    alert(ok ? 'é€šçŸ¥è¨±å¯OK' : 'é€šçŸ¥è¨±å¯ãŒå¾—ã‚‰ã‚Œã¾ã›ã‚“ã§ã—ãŸ');
    refreshEnv();
  });

  // ãƒ†ã‚¹ãƒˆ
  $('#test')?.addEventListener('click', async ()=>{
    if(await ensurePermission()){
      notify('ãƒ†ã‚¹ãƒˆé€šçŸ¥', 'ã“ã‚Œã¯ãƒ†ã‚¹ãƒˆã§ã™');
      beep();
      refreshEnv();
    }else{
      alert('é€šçŸ¥è¨±å¯ãŒå¿…è¦ã§ã™');
    }
  });

  // ç›£è¦–é–‹å§‹
  scheduleChecks();
});
```

---

## ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †ï¼ˆNetlifyï¼‰

1. ä¸Šè¨˜2ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ`index.html` ã¨ `app.js`ï¼‰ã‚’ãƒªãƒã‚¸ãƒˆãƒªã¾ãŸã¯ãƒ•ã‚©ãƒ«ãƒ€ã«é…ç½®ã€‚
2. Netlifyã«ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã§ã‚‚OKï¼‰ã€‚
3. ãƒšãƒ¼ã‚¸ã‚’é–‹ã„ã¦ã€ä¸Šéƒ¨ã®ã€ŒOrigin / SecureContext / Notificationã€ã‚’ç¢ºèªã€‚
4. ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼ã®ğŸ”’ã‹ã‚‰**é€šçŸ¥ã‚’è¨±å¯**â†’ã€Œãƒ†ã‚¹ãƒˆã€ã§é€šçŸ¥ï¼‹ãƒ“ãƒ¼ãƒ—ç¢ºèªã€‚

> ã‚‚ã—ç‹¬è‡ªã§CSPã‚’è¨­å®šã—ã¦ã„ã‚‹å ´åˆã¯ã€`script-src 'self'` ãŒå¿…è¦ã§ã™ï¼ˆæœ¬æ§‹æˆã¯ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³JSæœªä½¿ç”¨ï¼‰ã€‚
