<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WEB会議アラーム（シンプル版）</title>
  <style>
    :root{--bg:#0b1020;--card:#111a2b;--fg:#e7ecf3;--muted:#93a0b4;--line:#1e2a48;--btn:#1b2c55}
    *{box-sizing:border-box;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial}
    body{margin:0;background:#0b1020;color:var(--fg);padding:20px}
    h1{margin:0 0 8px;font-size:20px}
    .muted{color:var(--muted);font-size:12px}
    .wrap{max-width:860px;margin:auto}
    .grid{display:grid;gap:16px}
    @media(min-width:860px){.grid{grid-template-columns:1.1fr 1fr}}
    .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:16px}
    label{display:inline-block;min-width:56px}
    input,button{background:#0f1830;border:1px solid #26365f;color:var(--fg);border-radius:8px;padding:8px}
    input{width:100%;max-width:260px}
    button{cursor:pointer;background:var(--btn)}
    button:hover{filter:brightness(1.06)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:6px 0}
    .event{padding:10px;border:1px solid #2b4275;border-radius:10px;margin:8px 0}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>WEB会議アラーム（シンプル版）</h1>
    <div id="env" class="muted" style="margin:4px 0 16px"></div>

    <div class="grid">
      <!-- 入力フォーム -->
      <section class="card">
        <h2 style="margin:0 0 10px;font-size:16px">入力フォーム</h2>
        <div class="row">
          <label for="date">日付</label>
          <input id="date" type="date" />
        </div>
        <div class="row">
          <label for="time">時間</label>
          <input id="time" type="time" step="60" />
        </div>
        <div class="row">
          <label for="title">タイトル</label>
          <input id="title" type="text" placeholder="会議名（未入力なら『会議』）" />
        </div>
        <div class="row" style="margin-top:10px">
          <button id="add">追加</button>
          <button id="perm">通知許可</button>
          <button id="test">テスト</button>
        </div>
        <div class="muted" style="margin-top:10px">
          ※ 開始1分前／開始時刻にデスクトップ通知＋ビープ音が鳴ります。<br>
          ※ タブを閉じると動作しません。<br>
          ※ 通知は HTTPS または <code>http://localhost</code> での実行が安定します。
        </div>
      </section>

      <!-- 登録済み -->
      <section class="card">
        <h2 style="margin:0 0 10px;font-size:16px">登録済みスケジュール</h2>
        <div id="events"></div>
      </section>
    </div>
  </div>

  <script>
    // 便利関数
    const $ = sel => document.querySelector(sel);

    // 今日の文字列（YYYY-MM-DD）
    function todayStr(){
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${dd}`;
    }

    // Web Audio でビープ
    async function beep(){
      try{
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.type = 'sine';
        osc.frequency.value = 880;
        gain.gain.value = 0.08;
        osc.connect(gain); gain.connect(ctx.destination);
        osc.start(); osc.stop(ctx.currentTime + 0.2);
        setTimeout(()=>ctx.close(), 500);
      }catch(e){ console.warn('beep error:', e); }
    }

    // 通知権限
    async function ensurePermission(){
      if(!('Notification' in window)) return false;
      if(Notification.permission === 'granted') return true;
      if(Notification.permission !== 'denied'){
        const r = await Notification.requestPermission();
        return r === 'granted';
      }
      return false;
    }

    function notify(title, body){
      try{
        if('Notification' in window && Notification.permission === 'granted'){
          new Notification(title, { body });
        }
      }catch(e){ console.warn('notify error:', e); }
    }

    // 状態表示（Origin/SecureContext/Notification）
    function refreshEnv(){
      const host = location.host || '(file)';
      const secure = window.isSecureContext;
      const perm = ('Notification' in window) ? Notification.permission : 'unsupported';
      const envEl = $('#env');
      envEl.textContent = `Origin: ${host} / SecureContext: ${secure} / Notification: ${perm}`;
      if(!secure && host === ''){
        const tip = document.createElement('div');
        tip.className = 'muted';
        tip.style.marginTop = '6px';
        tip.innerHTML = '⚠️ file:// 実行では通知が不安定です。<b>localhost</b> で開いてください（例：<code>python -m http.server 8000</code> → <code>http://localhost:8000/</code>）。';
        envEl.appendChild(tip);
      }
    }

    // イベント配列（保存機能なし＝リロードで消える）
    const events = [];

    function render(){
      const wrap = $('#events');
      wrap.innerHTML = '';
      events.sort((a,b)=>a.time - b.time);
      for(const e of events){
        const div = document.createElement('div');
        div.className = 'event';
        const t = new Date(e.time).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        div.textContent = `${t} ${e.title}`;
        wrap.appendChild(div);
      }
    }

    function scheduleChecks(){
      setInterval(()=>{
        const now = Date.now();
        for(const e of events){
          // 1分前（1回）
          if(!e.firedPre && now >= e.time - 60_000 && now < e.time - 59_000){
            notify('会議1分前', e.title);
            beep();
            e.firedPre = true;
          }
          // 開始時（1回）
          if(!e.fired && now >= e.time && now < e.time + 10_000){
            notify('会議開始', e.title);
            beep();
            e.fired = true;
          }
        }
      }, 5000);
    }

    // 初期化
    window.addEventListener('load', ()=>{
      // 日付デフォルト＝今日
      $('#date').value = todayStr();
      refreshEnv();

      // 追加
      $('#add').addEventListener('click', ()=>{
        const d = $('#date').value;
        const t = $('#time').value;
        const title = ($('#title').value || '会議').trim();
        if(!d || !t){ alert('日付と時間を入力してください'); return; }
        const dt = new Date(`${d}T${t}`);
        events.push({ time: dt.getTime(), title, firedPre:false, fired:false });
        render();
      });

      // 通知許可
      $('#perm').addEventListener('click', async ()=>{
        const ok = await ensurePermission();
        alert(ok ? '通知許可OK' : '通知許可が得られませんでした');
        refreshEnv();
      });

      // テスト
      $('#test').addEventListener('click', async ()=>{
        if(await ensurePermission()){
          notify('テスト通知', 'これはテストです');
          beep();
          refreshEnv();
        }else{
          alert('通知許可が必要です');
        }
      });

      // 監視開始
      scheduleChecks();
    });
  </script>
</body>
</html>
